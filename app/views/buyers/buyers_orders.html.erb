<div class="d-flex justify-content-between">
   <%= link_to 'Go Back', request.referer || root_path, class: "btn setBtnStats p-2 px-3" %>

    <button id="consolidate-btn" class="btn setBtnStats" style="display: none"> Consolidate</button>
</div>
<div class="shadow mt-2 productTableRadius">
    <div class="table-responsive">
        <table class="table productTable text-center mobile-table" id="dataTable" width="100%" cellspacing="0">
            <thead>
                <tr>
                    <th class="pl-3"></th>
                    <th class="pl-3">ORDER NO</th>
                    <th class="">DATE</th>
                    <th> TOTAL AMOUNT</th>
                    <th>STATUS</th>
                    <th>ACTIONS</th>
                    <th></th>

                </tr>
            </thead>
            <tbody id="ordersList">
                <% if @orders.present? %>
                <% @orders.each do |order| %>
<tr class="clickable-row" data-href="/order-details/<%= order.id %>" style="cursor: pointer;">
                    <td>
                    <% if @orders.select { |o| o.order_items.any? { |item| item.inventory.seller == o.order_items.first.inventory.seller && o.forwarder == order.forwarder } }.size > 1 && order.created_at.to_date == Date.today %>
                        <input type="checkbox" class="order-checkbox" data-id="<%= order.id %>" data-seller-id="<%= order.order_items.first.inventory.seller.id %>" data-forwarder="<%= order.forwarder %>" data-date="<%= order.created_at.strftime("%Y-%m-%d") %>">
                    <% end %>
                    </td>
                    <td class="py-4">#<%= order.id %></td>
                    <td class="py-4"><%= order.created_at.strftime("%d %b %Y") %></td>
                    <td class="py-4"><%= number_to_currency(order.total_amount , precision: 0) %></td>
                    <td class="py-4 new-badge <%= "order-#{order.status.upcase}" %>">
                        <% if order.status == 'created' %>
                        <span class="blink-badge" style="top: 2px; left:130px;">New</span>
                        New
                        <% else %>
                        <%= order.status.capitalize %>
                        <% end %>

                    </td>
                    <td><a href="/order-details/<%= order.id %>" class="btn setBtnStats">VIEW</a></button>
                    <td><a href="/print-order?order=<%= order.id %>" target="_blank" class="">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <mask id="mask0_2071_6146" style="mask-type:alpha" maskUnits="userSpaceOnUse" x="0" y="0" width="24" height="24">
                                    <rect width="24" height="24" fill="#D9D9D9" />
                                </mask>
                                <g mask="url(#mask0_2071_6146)">
                                    <path d="M16 8V5H8V8H6V3H18V8H16ZM18 12.5C18.2833 12.5 18.5208 12.4042 18.7125 12.2125C18.9042 12.0208 19 11.7833 19 11.5C19 11.2167 18.9042 10.9792 18.7125 10.7875C18.5208 10.5958 18.2833 10.5 18 10.5C17.7167 10.5 17.4792 10.5958 17.2875 10.7875C17.0958 10.9792 17 11.2167 17 11.5C17 11.7833 17.0958 12.0208 17.2875 12.2125C17.4792 12.4042 17.7167 12.5 18 12.5ZM16 19V15H8V19H16ZM18 21H6V17H2V11C2 10.15 2.29167 9.4375 2.875 8.8625C3.45833 8.2875 4.16667 8 5 8H19C19.85 8 20.5625 8.2875 21.1375 8.8625C21.7125 9.4375 22 10.15 22 11V17H18V21ZM20 15V11C20 10.7167 19.9042 10.4792 19.7125 10.2875C19.5208 10.0958 19.2833 10 19 10H5C4.71667 10 4.47917 10.0958 4.2875 10.2875C4.09583 10.4792 4 10.7167 4 11V15H6V13H18V15H20Z" fill="#1C1B1F" />
                                </g>
                            </svg>
                        </a>
                    </td>



                </tr>
                <% end %>
                <% else %>
                <tr>
                    <td colspan="12" class="py-4">No orders found</td>
                </tr>
                <% end %>
            </tbody>
        </table>

    </div>
</div>
<div id="pagination">
    <%= paginate @orders %>
</div>
<script>
  $(document).ready(function() {
    const orderIds = <%= @orders.where(status: "created").pluck(:id).to_json.html_safe %>;
    if (orderIds.length > 0) {
      $.ajax({
        url: '<%= update_status_path %>',
        method: 'POST',
        headers: {
          'X-CSRF-Token': $('meta[name="csrf-token"]').attr('content')
        },
        contentType: 'application/json',
        data: JSON.stringify({ order_ids: orderIds }),
        success: function(data) {
          if (data.success) {
            console.log('Order statuses updated to processing.');
          } else {
            console.error('Failed to update order statuses.');
          }
        },
        error: function(xhr, status, error) {
          console.error('Error:', error);
        }
      });
    }

    function checkBuyerConsistency() {
      var selectedBuyerIds = [];
      var selectedForwarders = [];
      var selectedDates = [];
      
      $('.order-checkbox:checked').each(function() {
        selectedBuyerIds.push($(this).data('seller-id'));
        selectedForwarders.push($(this).data('forwarder'));
        selectedDates.push($(this).data('date'));
      });

      // No need to check if no orders are selected
      if (selectedBuyerIds.length === 0) {
        return true;
      }

      // Check if all sellers are the same
      if (new Set(selectedBuyerIds).size > 1) {
        toastr.error("Error: You cannot consolidate orders from different sellers.");
        $('.order-checkbox:checked').prop('checked', false); 
        return false;
      }
      
      // Check if all forwarders are the same
      if (new Set(selectedForwarders).size > 1) {
        toastr.error("Error: You cannot consolidate orders with different forwarders.");
        $('.order-checkbox:checked').prop('checked', false);
        return false;
      }
      
      // Check if all orders were created on the same day
      if (new Set(selectedDates).size > 1) {
        toastr.error("Error: You cannot consolidate orders created on different days.");
        $('.order-checkbox:checked').prop('checked', false);
        return false;
      }
      
      return true;
    }

    $('.order-checkbox').change(function() {
      var isValid = checkBuyerConsistency();
      // Use the global function from bids.js
      if (typeof window.toggleConsolidateButton === 'function') {
        window.toggleConsolidateButton($('.order-checkbox:checked').length >= 2 && isValid);
      }
    });
  });

  $(document).ready(function() {
    $(".clickable-row").click(function(event) {
      if ($(event.target).closest("input, button, a, .dropdown-menu, .dropdown-toggle, svg, path").length > 0) {
        return; 
      }
      window.location = $(this).data("href");
    });
  });
</script>
